<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Iscrizione Corsi Antincendio - IMBC Fire & Safety Academy</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
  <style>
    .error-message { color: #a00; display: none; margin-top: 6px; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:1000; }
    .modal-content { background:#fff; padding:20px; border-radius:6px; max-width:90%; width:700px; }
    canvas { max-width:100%; }
  </style>
</head>
<body>
  <div class="container">

    <!-- LOGO IMBC -->
    <img src="logo_imbc.png" alt="Logo IMBC" class="logo">

    <!-- Pulsante CONTATTI -->
    <button type="button" class="btn-contatti" onclick="openContattiModal()">CONTATTI</button>

    <header class="header-section">
      <h1>ISCRIZIONE CORSI ANTINCENDIO</h1>
      <h2 class="subtitle">IMBC Fire & Safety Academy</h2>
    </header>

    <!-- Modal CONTATTI -->
    <div id="contatti-modal" class="modal-overlay" style="display:none;">  
      <div class="modal-content">
        <button type="button" class="modal-close" onclick="closeContattiModal()">&times;</button>
        <h3 class="modal-title">Contatti e Segnalazione Problemi</h3>
        <form id="contatti-form" onsubmit="submitContattiForm(event)">
          <div class="form-group">
            <label for="contatti-problema">Descrivi il problema:</label>
            <textarea id="contatti-problema" rows="4" placeholder="Descrivi il problema riscontrato..." required></textarea>
          </div>
          <div class="form-group">
            <label for="contatti-email">La tua email:</label>
            <input type="email" id="contatti-email" placeholder="Inserisci la tua email" required>
          </div>
          <div class="form-group">
            <label for="contatti-telefono">Telefono:</label>
            <input type="text" id="contatti-telefono" placeholder="Inserisci il tuo numero di telefono">
          </div>
          <button type="submit" class="btn-submit-contatti">Invia segnalazione</button>
        </form>
        <div class="contatti-info">
          <p><strong>Oppure contattaci direttamente:</strong></p>
          <p>Email: <a href="mailto:info@imbcacademy.it">info@imbcacademy.it</a></p>
        </div>
      </div>
    </div>

    <!-- FORM ISCRIZIONE (Formspree) -->
    <main>
      <form id="iscrizione-form" action="https://formspree.io/f/xzdvygoo" method="POST" novalidate>
        <!-- Honeypot anti-spam -->
        <p class="hidden" style="display:none;">
          <label>Non compilare questo campo: <input name="bot-field" /></label>
        </p>

        <!-- Tipo Iscrizione -->
        <section class="form-section">
          <h3 class="section-title">Tipo di Iscrizione</h3>
          <div class="tipo-iscrizione-container">
            <label class="tipo-iscrizione-option">
              <input type="radio" name="tipo-iscrizione" id="tipo-privato" value="privato" checked>
              <span class="tipo-label"><strong>Privato</strong><small>Iscrizione individuale</small></span>
            </label>
            <label class="tipo-iscrizione-option">
              <input type="radio" name="tipo-iscrizione" id="tipo-azienda" value="azienda">
              <span class="tipo-label"><strong>Azienda</strong><small>Iscrizione di più persone</small></span>
            </label>
          </div>
        </section>

        <!-- Dati Azienda -->
        <section class="form-section" id="dati-azienda-section" style="display:none;">
          <h3 class="section-title">Dati Azienda</h3>

          <div class="form-group">
            <label for="ragione-sociale">Ragione Sociale:</label>
            <input type="text" id="ragione-sociale" name="ragione-sociale" placeholder="Inserisci la ragione sociale dell'azienda">
          </div>

          <div class="form-group">
            <label for="partita-iva">Partita IVA / Codice Fiscale Azienda:</label>
            <input type="text" id="partita-iva" name="partita-iva" placeholder="Inserisci P.IVA o Codice Fiscale" maxlength="16">
            <div id="partita-iva-error" class="error-message">La Partita IVA deve contenere 11 caratteri, il Codice Fiscale 16 caratteri.</div>
          </div>

          <div class="form-group">
            <label for="codice-sdi">Codice SDI (7 caratteri):</label>
            <input type="text" id="codice-sdi" name="codice-sdi" placeholder="Inserisci il codice SDI" maxlength="7">
          </div>

          <div class="form-group">
            <label for="indirizzo-azienda">Indirizzo Sede Legale:</label>
            <input type="text" id="indirizzo-azienda" name="indirizzo-azienda" placeholder="Via/Piazza, numero civico, CAP, Città, Provincia">
          </div>

          <div class="form-group">
            <label for="email-referente">Email Referente Aziendale:</label>
            <input type="email" id="email-referente" name="email-referente" placeholder="Inserisci l'email del referente aziendale">
          </div>

          <div class="form-group">
            <label for="pec-azienda">PEC Aziendale:</label>
            <input type="email" id="pec-azienda" name="pec-azienda" placeholder="Inserisci la PEC aziendale">
          </div>

          <div class="form-group">
            <label for="telefono-azienda">Telefono Azienda:</label>
            <input type="text" id="telefono-azienda" name="telefono-azienda" placeholder="Inserisci il numero di telefono aziendale">
          </div>

          <div class="form-group">
            <label for="settore-azienda">Settore di Appartenenza:</label>
            <select id="settore-azienda" name="settore-azienda">
              <option value="" disabled selected>Seleziona settore</option>
              <option value="Industria manifatturiera">Industria manifatturiera</option>
              <option value="Edilizia e costruzioni">Edilizia e costruzioni</option>
              <option value="Commercio">Commercio</option>
              <option value="Sanità">Sanità</option>
              <option value="Istruzione">Istruzione</option>
              <option value="Trasporti e logistica">Trasporti e logistica</option>
              <option value="Alberghiero e ristorazione">Alberghiero e ristorazione</option>
              <option value="Servizi">Servizi</option>
              <option value="Pubblica Amministrazione">Pubblica Amministrazione</option>
              <option value="Agricoltura">Agricoltura</option>
              <option value="Altro">Altro</option>
            </select>
          </div>
        </section>

        <!-- Partecipanti container -->
        <div id="partecipanti-container">
          <!-- Partecipante template (Partecipante 1 predefinito) -->
          <div class="form-section partecipante-section" data-partecipante-index="1">
            <h3 class="section-title">
              <span class="partecipante-title">Dati Partecipante 1</span>
              <button type="button" class="btn-remove-partecipante" style="display:none;" onclick="removePartecipante(this)">Rimuovi</button>
            </h3>

            <div class="form-group">
              <label for="partecipante-1-nome">Nome:</label>
              <input type="text" id="partecipante-1-nome" name="partecipante-1-nome" class="partecipante-nome" placeholder="Inserisci il nome" required>
            </div>

            <div class="form-group">
              <label for="partecipante-1-cognome">Cognome:</label>
              <input type="text" id="partecipante-1-cognome" name="partecipante-1-cognome" class="partecipante-cognome" placeholder="Inserisci il cognome" required>
            </div>

            <div class="form-group">
              <label for="partecipante-1-email">Email:</label>
              <input type="email" id="partecipante-1-email" name="partecipante-1-email" class="partecipante-email" placeholder="Inserisci l'email" required>
            </div>

            <div class="form-group privato-only-field">
              <label for="partecipante-1-telefono">Telefono:</label>
              <input type="text" id="partecipante-1-telefono" name="partecipante-1-telefono" class="partecipante-telefono" placeholder="Inserisci il numero di telefono" required>
            </div>

            <div class="form-group">
              <label for="partecipante-1-codice-fiscale">Codice Fiscale:</label>
              <input type="text" id="partecipante-1-codice-fiscale" name="partecipante-1-codice-fiscale" class="partecipante-codice-fiscale" placeholder="Inserisci il codice fiscale" maxlength="16">
              <div class="error-message codice-fiscale-error">Il codice fiscale deve contenere esattamente 16 caratteri.</div>
            </div>

            <div class="form-group">
              <label for="partecipante-1-profilo">Profilo Professionale / Mansione:</label>
              <input type="text" id="partecipante-1-profilo" name="partecipante-1-profilo" class="partecipante-profilo" placeholder="Es. Responsabile sicurezza, Operaio, Tecnico..." required>
            </div>

            <div class="form-group privato-only-field">
              <label for="partecipante-1-settore">Settore di Appartenenza:</label>
              <select id="partecipante-1-settore" name="partecipante-1-settore" class="partecipante-settore">
                <option value="" disabled selected>Seleziona settore</option>
                <option value="Industria manifatturiera">Industria manifatturiera</option>
                <option value="Edilizia e costruzioni">Edilizia e costruzioni</option>
                <option value="Commercio">Commercio</option>
                <option value="Sanità">Sanità</option>
                <option value="Istruzione">Istruzione</option>
                <option value="Trasporti e logistica">Trasporti e logistica</option>
                <option value="Alberghiero e ristorazione">Alberghiero e ristorazione</option>
                <option value="Servizi">Servizi</option>
                <option value="Pubblica Amministrazione">Pubblica Amministrazione</option>
                <option value="Agricoltura">Agricoltura</option>
                <option value="Altro">Altro</option>
              </select>
            </div>

          </div>
        </div>

        <!-- Aggiungi partecipante (solo per aziende) -->
        <div id="aggiungi-partecipante-container" style="display:none;">
          <button type="button" class="btn-add-partecipante" onclick="addPartecipante()">+ Aggiungi Partecipante</button>
        </div>

        <!-- Dettagli Corso -->
        <section class="form-section">
          <h3 class="section-title">Dettagli Corso</h3>

          <div class="form-group">
            <label for="corso">Titolo Corso:</label>
            <select id="corso" name="corso" required>
              <option value="" disabled selected>Seleziona corso</option>
              <option value="Antincendio livello 1 – 4 ore">Antincendio livello 1 – 4 ore</option>
              <option value="Antincendio livello 2 – 8 ore">Antincendio livello 2 – 8 ore</option>
              <option value="Antincendio livello 3 – 16 ore">Antincendio livello 3 – 16 ore</option>
              <option value="Aggiornamento livello 1 – 2 ore">Aggiornamento livello 1 – 2 ore</option>
              <option value="Aggiornamento livello 2 – 5 ore">Aggiornamento livello 2 – 5 ore</option>
              <option value="Aggiornamento livello 3 – 8 ore">Aggiornamento livello 3 – 8 ore</option>
            </select>
          </div>

          <div class="form-group">
            <label for="prezzo">Quota di partecipazione per persona (€):</label>
            <input type="text" id="prezzo" name="prezzo" readonly>
          </div>

          <div class="form-group" id="totale-container" style="display:none;">
            <label for="totale">Totale (€):</label>
            <input type="text" id="totale" name="totale" readonly>
            <small class="totale-info">Calcolato in base al numero di partecipanti</small>
          </div>
        </section>

        <!-- Termini e modalità di pagamento -->
        <section class="form-section">
          <h3 class="section-title">Modalità di iscrizione e pagamento</h3>
          <div class="terms">
            <label class="term-item">
              <input type="checkbox" class="required-checkbox" name="term-1" required>
              <span class="term-text">1) L'iscrizione al corso è subordinata al pagamento anticipato dell'intero importo. Seleziona la modalità di pagamento preferita:</span>
            </label>

            <div class="payment-method-selection">
              <label class="payment-method-option">
                <input type="radio" name="metodo-pagamento" id="pagamento-bonifico" value="bonifico" required>
                <span class="payment-method-label"><strong>Bonifico Bancario</strong></span>
              </label>
              <label class="payment-method-option">
                <input type="radio" name="metodo-pagamento" id="pagamento-carta" value="carta">
                <span class="payment-method-label"><strong>Carta di Credito / Debito / Google Pay</strong></span>
              </label>
            </div>

            <div id="bonifico-details" class="payment-bonifico-section" style="display:none;">
              <div class="payment-info-box">
                <p><strong>Coordinate Bancarie:</strong></p>
                <p>Intestatario: <strong>MICHELA COCCO</strong></p>
                <p>Banca: <strong>BANCA FINDOMESTIC</strong></p>
                <p>IBAN: <strong>IT65U0311514000000000000005566</strong></p>
              </div>
            </div>

            <div id="carta-details" class="payment-carta-section" style="display:none;">
              <div class="payment-info-box">
                <p><strong>Pagamento con Carta di Credito / Debito / Google Pay</strong></p>
                <p>Inserisci la tua email per ricevere il link di pagamento sicuro.</p>
                <div class="form-group">
                  <label for="email-pagamento">Email per link di pagamento:</label>
                  <input type="email" id="email-pagamento" name="email-pagamento" placeholder="Inserisci email per link di pagamento">
                </div>
              </div>
            </div>

            <label class="term-item">
              <input type="checkbox" class="required-checkbox" name="term-2" required>
              <span class="term-text">2) L'iscrizione si considera perfezionata al momento del ricevimento della scheda compilata e sottoscritta, unitamente alla copia della ricevuta di pagamento.</span>
            </label>

            <label class="term-item">
              <input type="checkbox" class="required-checkbox" name="term-3" required>
              <span class="term-text">3) In caso di mancata presentazione, IMBC FIRE & SAFETY ACADEMY sarà autorizzata ad emettere fattura per l'intero importo e trattenere l'importo versato.</span>
            </label>

            <label class="term-item">
              <input type="checkbox" class="required-checkbox" name="term-4" required>
              <span class="term-text">4) In caso di ritiro durante il corso, IMBC FIRE & SAFETY ACADEMY emetterà fattura per l'intero importo garantendo il diritto al materiale didattico distribuito.</span>
            </label>

            <label class="term-item">
              <input type="checkbox" class="required-checkbox" name="term-5" required>
              <span class="term-text">5) IMBC FIRE & SAFETY ACADEMY si riserva la facoltà di annullare o rinviare i corsi programmati. Ogni variazione sarà tempestivamente comunicata.</span>
            </label>
          </div>
        </section>

        <!-- Informativa Privacy (testo + autorizzazione SENZA firma) -->
        <section class="form-section privacy-section">
          <h3 class="section-title">Informativa Privacy</h3>
          <div class="privacy-content">
            <p><strong>Informativa Privacy – Iscrizione Corsi Antincendio IMBC</strong></p>
            <p>Ai sensi degli artt. 13 e 14 del Regolamento UE 2016/679 (GDPR), IMBC FIRE & SAFETY ACADEMY, con sede legale in Vezzano Ligure (SP), 19020, via Caffaggio 1, tratta i dati forniti per le finalità connesse alla gestione delle iscrizioni ai corsi antincendio.</p>
            <ul>
              <li>Gestione dell'iscrizione e partecipazione al corso, inclusa la generazione della scheda iscrizione e del PDF allegato.</li>
              <li>Invio di comunicazioni relative all'attività formativa, materiali didattici, certificazioni e informazioni organizzative.</li>
              <li>Adempimenti fiscali, contabili e normativi connessi all'erogazione dei corsi.</li>
              <li>Comunicazione a soggetti terzi e autorità competenti quando richiesto dalla normativa.</li>
            </ul>
            <p><strong>Base giuridica del trattamento:</strong> il trattamento si basa sul consenso espresso tramite le checkbox presenti nel modulo.</p>
            <p><strong>Modalità di trattamento:</strong> i dati saranno trattati elettronicamente tramite sistemi informatici sicuri e conservati secondo le misure di sicurezza previste dalla normativa.</p>
            <p><strong>Conservazione dei dati:</strong> i dati saranno conservati per il tempo necessario a soddisfare le finalità di trattamento e in conformità con le normative vigenti.</p>
            <p><strong>Diritti dell'interessato:</strong> puoi esercitare i diritti di accesso, rettifica, cancellazione, limitazione del trattamento, opposizione e portabilità dei dati (artt. 15-22 GDPR) contattando il Titolare del trattamento all'indirizzo email info@imbcacademy.it.</p>
            <p><strong>Accettazione:</strong> spuntando le checkbox richieste nel modulo confermi di aver preso visione dell'informativa e di fornire il consenso al trattamento dei dati personali per le finalità indicate.</p>
          </div>

          <div class="privacy-date">
            <label for="data-privacy">Data di sottoscrizione:</label>
            <input type="text" id="data-privacy" name="data-privacy" readonly>
          </div>

          <div class="privacy-authorization">
            <p><strong>Autorizzazione al trattamento dei dati personali:</strong></p>
            <label class="radio-item">
              <input type="radio" name="privacy-consent" id="privacy-autorizza" value="autorizza" required>
              <span>Autorizzo il trattamento dei miei dati personali</span>
            </label>
            <label class="radio-item">
              <input type="radio" name="privacy-consent" id="privacy-non-autorizza" value="non-autorizza">
              <span>Non autorizzo il trattamento dei miei dati personali</span>
            </label>
            <div id="privacy-error-message" class="error-message">È impossibile procedere all'iscrizione al corso senza autorizzazione al trattamento dei dati personali.</div>
          </div>
        </section>

        <!-- FIRMA UNICA (in fondo) -->
        <section class="form-section" id="unica-firma-section">
          <h3 class="section-title">Firma di Autenticazione / Metodo Alternativo</h3>

          <div class="form-group">
            <label>Scegli il metodo di autenticazione:</label>
            <div class="signature-type-toggle">
              <label class="signature-type-option"><input type="radio" name="unica-signature-type" value="draw" checked> Disegna firma</label>
              <label class="signature-type-option"><input type="radio" name="unica-signature-type" value="text"> Scrivi il testo (firma)</label>
              <label class="signature-type-option"><input type="radio" name="unica-signature-type" value="certified"> Firma certificata</label>
              <label class="signature-type-option"><input type="radio" name="unica-signature-type" value="alternative"> Autenticazione alternativa</label>
            </div>
          </div>

          <div class="signature-draw-container unica-signature-draw">
            <canvas id="unica-firma-pad" width="400" height="150" style="border:1px solid #ccc;"></canvas>
            <div><button type="button" class="btn-secondary" onclick="clearUnicaFirma()">Cancella firma</button></div>
            <div id="unica-draw-error" class="error-message">Disegna la firma prima di inviare.</div>
          </div>

          <div class="signature-text-container unica-signature-text" style="display:none;">
            <input type="text" id="unica-firma-text" class="signature-text-input" placeholder="Scrivi nome e cognome per generare la firma">
            <canvas id="unica-firma-text-preview" class="signature-text-preview" width="400" height="150" style="border:1px solid #ccc;"></canvas>
            <div id="unica-text-error" class="error-message">Inserisci il testo della firma prima di inviare.</div>
          </div>

          <div class="signature-certified-container unica-signature-certified" style="display:none;">
            <div class="form-group">
              <label for="unica-cert-nome">Nome e Cognome del firmatario:</label>
              <input type="text" id="unica-cert-nome" name="unica-cert-nome" placeholder="Nome e cognome come da certificato">
            </div>
            <div class="form-group">
              <label for="unica-cert-cf">Codice Fiscale del firmatario:</label>
              <input type="text" id="unica-cert-cf" name="unica-cert-cf" placeholder="Codice fiscale" maxlength="16">
            </div>
            <div class="form-group">
              <label for="unica-cert-provider">Provider Firma Digitale:</label>
              <select id="unica-cert-provider" name="unica-cert-provider">
                <option value="" disabled selected>Seleziona il provider</option>
                <option value="InfoCert">InfoCert</option>
                <option value="Aruba">Aruba</option>
                <option value="Poste Italiane">Poste Italiane</option>
                <option value="Namirial">Namirial</option>
                <option value="Actalis">Actalis</option>
                <option value="Intesa Sanpaolo">Intesa Sanpaolo</option>
                <option value="Altro">Altro</option>
              </select>
            </div>
            <div id="unica-certified-error" class="error-message">Compila almeno Nome e Codice Fiscale per la firma certificata.</div>
          </div>

          <div class="signature-alternative-container unica-signature-alt" style="display:none;">
            <div class="form-group">
              <label for="alt-auth-name">Nome e Cognome:</label>
              <input type="text" id="alt-auth-name" name="alt-auth-name" placeholder="Inserisci nome e cognome">
            </div>
            <div class="form-group">
              <label><input type="checkbox" id="alt-auth-confirm" name="alt-auth-confirm"> Dichiaro di essere l'intestario dei dati e confermo l'autenticazione</label>
            </div>
            <input type="hidden" name="alt-auth-timestamp" id="alt-auth-timestamp" value="">
            <div id="unica-alt-error" class="error-message">Per l'autenticazione alternativa occorre nome e conferma della dichiarazione.</div>
          </div>
        </section>

        <div class="form-actions">
          <button type="submit" class="btn-submit">Invia iscrizione</button>
        </div>

      </form>
    </main>

    <!-- Modal Successo Iscrizione -->
    <div id="success-modal" class="modal-overlay" style="display:none;">
      <div class="modal-content success-modal-content">
        <div class="success-icon" style="font-size:40px; color:green;">&#10004;</div>
        <h3 class="modal-title success-title">Iscrizione Perfezionata con Successo!</h3>
        <div class="success-message">
          <p>Grazie per aver scelto <strong>IMBC Fire & Safety Academy</strong>!</p>
          <p>La tua iscrizione al corso antincendio è stata ricevuta e sarà elaborata a breve.</p>
          <p>Riceverai una conferma all'indirizzo email indicato.</p>
          <p class="success-note">Per qualsiasi informazione, contattaci a <a href="mailto:info@imbcacademy.it">info@imbcacademy.it</a></p>
        </div>
        <div class="success-buttons" style="margin-top:12px;">
          <button type="button" class="btn-print-pdf" onclick="downloadRegistrationPDF()">Stampa PDF</button>
          <button type="button" class="btn-submit" onclick="closeSuccessModal()">Chiudi</button>
        </div>
      </div>
    </div>

    <footer>
      <p>© IMBC Fire & Safety Academy</p>
    </footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
  (function(){
    const priceMap = {
      "Antincendio livello 1 – 4 ore": 60,
      "Antincendio livello 2 – 8 ore": 85,
      "Antincendio livello 3 – 16 ore": 170,
      "Aggiornamento livello 1 – 2 ore": 45,
      "Aggiornamento livello 2 – 5 ore": 60,
      "Aggiornamento livello 3 – 8 ore": 90
    };

    const iscrForm = document.getElementById('iscrizione-form');
    const tipoPrivato = document.getElementById('tipo-privato');
    const tipoAzienda = document.getElementById('tipo-azienda');
    const datiAziendaSection = document.getElementById('dati-azienda-section');
    const aggiungiPartecipanteContainer = document.getElementById('aggiungi-partecipante-container');
    const partecipantiContainer = document.getElementById('partecipanti-container');
    const corsoSelect = document.getElementById('corso');
    const prezzoInput = document.getElementById('prezzo');
    const totaleContainer = document.getElementById('totale-container');
    const totaleInput = document.getElementById('totale');
    const bonificoDetails = document.getElementById('bonifico-details');
    const cartaDetails = document.getElementById('carta-details');
    const successModal = document.getElementById('success-modal');
    const contattiModal = document.getElementById('contatti-modal');
    const dataPrivacyInput = document.getElementById('data-privacy');

    const signaturePads = {};

    function setPrivacyDate(){ const d=new Date(); if(dataPrivacyInput) dataPrivacyInput.value = d.toLocaleDateString('it-IT'); }
    setPrivacyDate();

    function updateTipoIscrizione(){
      const isAzienda = tipoAzienda.checked;
      datiAziendaSection.style.display = isAzienda ? '' : 'none';
      aggiungiPartecipanteContainer.style.display = isAzienda ? '' : 'none';
      document.querySelectorAll('.privato-only-field').forEach(el=>{ el.style.display = isAzienda ? 'none':''; el.querySelectorAll('input,select').forEach(i=>{ if(isAzienda) i.required=false; }); });
    }
    tipoPrivato.addEventListener('change', updateTipoIscrizione);
    tipoAzienda.addEventListener('change', updateTipoIscrizione);
    updateTipoIscrizione();

    document.querySelectorAll('input[name="metodo-pagamento"]').forEach(r=>r.addEventListener('change',()=>{ const sel=document.querySelector('input[name="metodo-pagamento"]:checked'); const v=sel?sel.value:''; bonificoDetails.style.display=v==='bonifico'? '':''; cartaDetails.style.display=v==='carta'? 'none' : 'none'; }));

    function updatePrezzoETotale(){ const corso=corsoSelect.value; const prezzo=priceMap[corso]||''; prezzoInput.value = prezzo!==''?prezzo.toFixed(2):''; const partecipanti = partecipantiContainer.querySelectorAll('.partecipante-section').length; if(prezzo!=='' && partecipanti>0){ totaleContainer.style.display=''; totaleInput.value = (prezzo*partecipanti).toFixed(2);} else { totaleContainer.style.display='none'; totaleInput.value=''; }}
    corsoSelect.addEventListener('change', updatePrezzoETotale);

    let partecipanteIndex=1;
    function addPartecipante(){ partecipanteIndex++; const idx=partecipanteIndex; const wrapper=document.createElement('div'); wrapper.className='form-section partecipante-section'; wrapper.dataset.partecipanteIndex=idx; wrapper.innerHTML = `...`; partecipantiContainer.appendChild(wrapper); updatePrezzoETotale(); }
    window.addPartecipante=addPartecipante;
    window.removePartecipante=function(btn){ const s=btn.closest('.partecipante-section'); if(s){ s.remove(); updatePrezzoETotale(); }};

    function initSignaturePadForCanvas(canvas){ if(!canvas) return; try{ const pad=new SignaturePad(canvas); signaturePads[canvas.id]=pad;}catch(e){console.warn('sig pad',e);} }
    initSignaturePadForCanvas(document.getElementById('unica-firma-pad'));
    initSignaturePadForCanvas(document.getElementById('legale-signature-pad'));
    window.clearUnicaFirma=function(){ const c=document.getElementById('unica-firma-pad'); if(c && signaturePads[c.id]) signaturePads[c.id].clear(); };
    window.clearLegaleSignature=function(){ const c=document.getElementById('legale-signature-pad'); if(c && signaturePads[c.id]) signaturePads[c.id].clear(); };

    function drawTextToCanvas(text,canvas){ if(!canvas) return; const ctx=canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width,canvas.height); ctx.fillStyle='#000'; let fontSize=36; ctx.font=fontSize+'px "Montserrat", "Open Sans", sans-serif'; ctx.textBaseline='middle'; while(ctx.measureText(text).width>canvas.width-20 && fontSize>10){ fontSize-=2; ctx.font=fontSize+'px "Montserrat", "Open Sans", sans-serif'; } ctx.fillText(text,10,canvas.height/2); }
    const unicaTextInput=document.getElementById('unica-firma-text'); if(unicaTextInput) unicaTextInput.addEventListener('input',()=>drawTextToCanvas(unicaTextInput.value||'', document.getElementById('unica-firma-text-preview')));
    const legaleTextInput=document.getElementById('legale-signature-text'); if(legaleTextInput) legaleTextInput.addEventListener('input',()=>drawTextToCanvas(legaleTextInput.value||'', document.getElementById('legale-signature-text-preview')));

    function isCanvasBlank(canvas){ if(!canvas) return true; try{ const ctx=canvas.getContext('2d'); const data=ctx.getImageData(0,0,canvas.width,canvas.height).data; for(let i=3;i<data.length;i+=4){ if(data[i]!=0) return false;} }catch(e){return false;} return true; }

    function validateSignatures(){ document.querySelectorAll('.error-message').forEach(e=>e.style.display='none'); const privacy=document.querySelector('input[name="privacy-consent"]:checked'); if(!privacy || privacy.value!=='autorizza'){ document.getElementById('privacy-error-message').style.display=''; return {ok:false,msg:'Autorizzazione privacy mancante'} }
      const unicaType=(document.querySelector('input[name="unica-signature-type"]:checked')||{}).value||'draw'; if(unicaType==='draw'){ const c=document.getElementById('unica-firma-pad'); if(!c || !signaturePads[c.id] || signaturePads[c.id].isEmpty()){ document.getElementById('unica-draw-error').style.display=''; return {ok:false,msg:'Firma unica (disegna) mancante'} } } else if(unicaType==='text'){ const txt=(document.getElementById('unica-firma-text')||{}).value||''; if(!txt.trim()){ document.getElementById('unica-text-error').style.display=''; return {ok:false,msg:'Firma unica (testo) mancante'} } } else if(unicaType==='certified'){ const nome=(document.getElementById('unica-cert-nome')||{}).value||''; const cf=(document.getElementById('unica-cert-cf')||{}).value||''; if(!nome.trim()||!cf.trim()){ document.getElementById('unica-certified-error').style.display=''; return {ok:false,msg:'Dettagli firma certificata mancanti'} } } else if(unicaType==='alternative'){ const alt=(document.getElementById('alt-auth-name')||{}).value||''; const conf=(document.getElementById('alt-auth-confirm')||{}).checked; if(!alt.trim()||!conf){ document.getElementById('unica-alt-error').style.display=''; return {ok:false,msg:'Autenticazione alternativa incompleta'} } }
      if(tipoAzienda.checked){ const legaleType=(document.querySelector('input[name="legale-signature-type"]:checked')||{}).value||'draw'; if(legaleType==='draw'){ const c=document.getElementById('legale-signature-pad'); if(!c||!signaturePads[c.id]||signaturePads[c.id].isEmpty()){ document.getElementById('legale-draw-error').style.display=''; return {ok:false,msg:'Firma del legale mancante'} } } else if(legaleType==='text'){ const txt=(document.getElementById('legale-signature-text')||{}).value||''; if(!txt.trim()){ document.getElementById('legale-text-error').style.display=''; return {ok:false,msg:'Firma del legale (testo) mancante'} } } else if(legaleType==='certified'){ formData.append('legale-cert-nome', (document.getElementById('legale-cert-nome')||{}).value||''); formData.append('legale-cert-cf', (document.getElementById('legale-cert-cf')||{}).value||''); formData.append('legale-cert-provider', (document.getElementById('legale-cert-provider')||{}).value||''); } }
      return {ok:true,msg:''}; }

    // Submit with fetch so we can show modal and not reload
    iscrForm.addEventListener('submit', async function(e){ e.preventDefault(); const v=validateSignatures(); if(!v.ok){ alert(v.msg); return; }
      // if alternative auth, set timestamp
      const altSel=document.querySelector('input[name="unica-signature-type"]:checked'); if(altSel && altSel.value==='alternative'){ document.getElementById('alt-auth-timestamp').value=new Date().toISOString(); }
      const formData=new FormData(iscrForm);
      // attach unique signature
      const unicaType=(document.querySelector('input[name="unica-signature-type"]:checked')||{}).value||'draw'; formData.append('unica-signature-type', unicaType);
      if(unicaType==='draw'){ const c=document.getElementById('unica-firma-pad'); if(c && signaturePads[c.id] && !signaturePads[c.id].isEmpty()){ formData.append('firma-unica-image', signaturePads[c.id].toDataURL('image/png')); } }
      else if(unicaType==='text'){ const txt=(document.getElementById('unica-firma-text')||{}).value||''; const preview=document.getElementById('unica-firma-text-preview'); if(txt && preview){ try{ formData.append('firma-unica-image', preview.toDataURL('image/png')); }catch(e){} formData.append('firma-unica-text', txt); } }
      else if(unicaType==='certified'){ } 
      try{
        const resp=await fetch(iscrForm.action, { method:'POST', body:formData, headers:{ 'Accept':'application/json' } });
        console.log('Formspree response status:', resp.status);
        if(resp.ok){ successModal.style.display=''; iscrForm.reset(); setPrivacyDate(); updatePrezzoETotale(); Object.keys(signaturePads).forEach(id=>{ try{ signaturePads[id].clear(); }catch(e){} }); }
        else{ let detail=''; try{ const ct=resp.headers.get('content-type')||''; if(ct.indexOf('application/json')!==-1){ const j=await resp.json(); detail=j.error||JSON.stringify(j); } else { detail=await resp.text(); } }catch(e){ detail='Nessun dettaglio disponibile'; } alert('Errore invio (status '+resp.status+'): '+detail); }
      }catch(err){ console.error(err); alert('Errore di rete durante l\'invio. Riprova più tardi.'); }
    });

    // PDF generation
    window.downloadRegistrationPDF = function(){ const jspdfLib=window.jspdf; if(!jspdfLib||!jspdfLib.jsPDF){ alert('Errore: libreria jsPDF non trovata.'); return; } const { jsPDF } = jspdfLib; const doc=new jsPDF({unit:'pt', format:'a4'}); const marginX=40; let y=40; const pageHeight=doc.internal.pageSize.getHeight(); const lineHeight=16; doc.setFontSize(16); doc.text('Iscrizione Corso - IMBC Fire & Safety Academy', marginX, y); y+=24; const corso=(document.getElementById('corso')&&document.getElementById('corso').value)||'N/D'; const prezzo=(document.getElementById('prezzo')&&document.getElementById('prezzo').value)||''; const totale=(document.getElementById('totale')&&document.getElementById('totale').value)||''; doc.setFontSize(12); doc.text(`Corso: ${corso}`, marginX, y); y+=lineHeight; if(prezzo){ doc.text(`Quota per persona: € ${prezzo}`, marginX, y); y+=lineHeight; } if(totale){ doc.text(`Totale: € ${totale}`, marginX, y); y+=lineHeight+6; } const tipoIscr=document.querySelector('input[name="tipo-iscrizione"]:checked'); if(tipoIscr && tipoIscr.value==='azienda'){ const rag=document.getElementById('ragione-sociale')&&document.getElementById('ragione-sociale').value; if(rag){ doc.text(`Ragione Sociale: ${rag}`, marginX, y); y+=lineHeight; } const piva=document.getElementById('partita-iva')&&document.getElementById('partita-iva').value; if(piva){ doc.text(`P.IVA / C.F. azienda: ${piva}`, marginX, y); y+=lineHeight; } y+=6; }
      doc.setFontSize(14); doc.text('Partecipanti:', marginX, y); y+=lineHeight; doc.setFontSize(11); const partecipanti=document.querySelectorAll('.partecipante-section'); partecipanti.forEach((p,idx)=>{ const nome=(p.querySelector('.partecipante-nome')||{}).value||''; const cogn=(p.querySelector('.partecipante-cognome')||{}).value||''; const email=(p.querySelector('.partecipante-email')||{}).value||''; const cf=(p.querySelector('.partecipante-codice-fiscale')||{}).value||''; const prof=(p.querySelector('.partecipante-profilo')||{}).value||''; const line=`${idx+1}. ${nome} ${cogn}`+(prof?` — ${prof}`:'')+(email?` — ${email}`:'')+(cf?` — CF: ${cf}`:''); if(y+40>pageHeight-80){ doc.addPage(); y=40; } doc.text(line, marginX, y); y+=lineHeight; }); y+=8;
      function addSignatureIfPresent(id,title){ const canvas=document.getElementById(id); if(!canvas) return; if(isCanvasBlank(canvas)) return; try{ const dataUrl=canvas.toDataURL('image/png'); const imgProps=doc.getImageProperties(dataUrl); const maxWidth=220; const imgW=Math.min(maxWidth, imgProps.width); const imgH=(imgProps.height*imgW)/imgProps.width; if(y+imgH+40>pageHeight-40){ doc.addPage(); y=40; } doc.setFontSize(12); doc.text(title, marginX, y); y+=lineHeight; doc.addImage(dataUrl,'PNG',marginX,y,imgW,imgH); y+=imgH+12; }catch(e){ console.warn('pdf sig',e);} }
      addSignatureIfPresent('unica-firma-pad','Firma di Autenticazione (disegno)'); addSignatureIfPresent('unica-firma-text-preview','Firma di Autenticazione (testo)'); addSignatureIfPresent('legale-signature-pad','Firma Legale (disegno)'); addSignatureIfPresent('legale-signature-text-preview','Firma Legale (testo)'); const unicaType=(document.querySelector('input[name="unica-signature-type"]:checked')||{}).value; if(unicaType==='certified'){ const nome=(document.getElementById('unica-cert-nome')||{}).value||''; const cf=(document.getElementById('unica-cert-cf')||{}).value||''; const prov=(document.getElementById('unica-cert-provider')||{}).value||''; if(y+60>pageHeight-60){ doc.addPage(); y=40; } doc.setFontSize(12); doc.text('Dettagli firma certificata:', marginX, y); y+=lineHeight; if(nome){ doc.text(`Nome: ${nome}`, marginX, y); y+=lineHeight; } if(cf){ doc.text(`Codice Fiscale: ${cf}`, marginX, y); y+=lineHeight; } if(prov){ doc.text(`Provider: ${prov}`, marginX, y); y+=lineHeight; } y+=8; }
      if(unicaType==='alternative'){ const altName=(document.getElementById('alt-auth-name')||{}).value||''; const altConfirm=(document.getElementById('alt-auth-confirm')||{}).checked?'SI':'NO'; const altTimestamp=(document.getElementById('alt-auth-timestamp')||{}).value||new Date().toISOString(); if(y+60>pageHeight-60){ doc.addPage(); y=40; } doc.setFontSize(12); doc.text('Autenticazione alternativa:', marginX, y); y+=lineHeight; if(altName){ doc.text(`Nome: ${altName}`, marginX, y); y+=lineHeight; } doc.text(`Conferma dichiarazione: ${altConfirm}`, marginX, y); y+=lineHeight; doc.text(`Timestamp: ${altTimestamp}`, marginX, y); y+=lineHeight+8; }
      doc.setFontSize(10); const nowStr=new Date().toLocaleString(); const footerY=doc.internal.pageSize.getHeight()-30; doc.text(`Generato il ${nowStr}`, marginX, footerY); const filename=`iscrizione_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.pdf`; try{ doc.save(filename);}catch(e){ console.error('pdf save',e); alert('Errore durante la generazione del PDF.'); } };

    // contact modal helpers
    window.openContattiModal=function(){ contattiModal.style.display=''; };
    window.closeContattiModal=function(){ contattiModal.style.display='none'; };
    window.submitContattiForm=function(e){ e.preventDefault(); alert('Segnalazione inviata. Grazie.'); closeContattiModal(); };
    window.closeSuccessModal=function(){ successModal.style.display='none'; };

  })();
  </script>
</body>
</html>